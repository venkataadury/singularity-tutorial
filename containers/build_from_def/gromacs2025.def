Bootstrap: docker
From: nvidia/cuda:12.6.3-devel-ubuntu24.04

%files
    gromacs-2025.3.tar.gz /gromacs.tar.gz

%environment
    export LC_ALL=C
    export PATH="/alphafold3_venv/bin:/hmmer/bin:/bin:/usr/bin:$PATH"
    export XLA_FLAGS="--xla_gpu_enable_triton_gemm=false"
    export XLA_PYTHON_CLIENT_PREALLOCATE=true
    export XLA_CLIENT_MEM_FRACTION=0.95

%post
    which nvcc # Making sure nvcc exists
    mkdir -p /usr/software
    cd /usr/software && mv /gromacs.tar.gz .
    tar -xf gromacs.tar.gz && rm gromacs.tar.gz && mv gromacs* gromacs_source

    apt-get -y update
    apt-get install --yes --quiet python3.12 python3-pip python3.12-dev # Python
    apt-get install --yes --quiet git wget gcc g++ make zlib1g-dev zstd patch libgl1-mesa-dev libglu1-mesa-dev libglew-dev cmake make libopenmpi-dev # Basic system requirements

    cd gromacs_source
    
    # GROMACS installation instructions (https://manual.gromacs.org/2025-current/install-guide/index.html)
    mkdir build && cd build
    cmake .. -DGMX_BUILD_OWN_FFTW=ON -DREGRESSIONTEST_DOWNLOAD=ON -DCMAKE_INSTALL_PREFIX=/usr/software/gromacs2025 -DGMX_GPU=CUDA -DGMX_MPI=off
    make -j 12
    make install
    echo "source /usr/software/gromacs2025/bin/GMXRC" > /usr/software/gromacs2025/sourceme.sh # Source gromacs for the future

%runscript
    source /usr/software/gromacs2025/bin/GMXRC && gmx $@
